name: DamnCRUD - Functional Testing CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run tests setiap hari jam 2 pagi UTC
    - cron: '0 2 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
          MYSQL_ROOT_PASSWORD: ''
          MYSQL_DATABASE: damncrud
        options: >
          --health-cmd="mysqladmin ping -u root"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2 php php-mysql php-cli libapache2-mod-php

    - name: Configure Apache for DamnCRUD
      run: |
        sudo a2enmod rewrite
        sudo usermod -a -G www-data $USER
        sudo chown -R www-data:www-data /var/www/html
        sudo mkdir -p /var/www/html/DamnCRUD
        sudo cp -r . /var/www/html/DamnCRUD/
        sudo chown -R www-data:www-data /var/www/html/DamnCRUD
        
        # Create Apache config
        echo '<VirtualHost *:80>
          DocumentRoot /var/www/html
          <Directory /var/www/html>
            AllowOverride All
            Require all granted
          </Directory>
        </VirtualHost>' | sudo tee /etc/apache2/sites-available/000-default.conf
        
        sudo systemctl start apache2
        sudo systemctl enable apache2

    - name: Wait for Apache and MySQL to start
      run: |
        sleep 10
        # Wait for MySQL to be ready
        for i in {1..30}; do
          mysql -h 127.0.0.1 -u root --protocol=TCP -e "SELECT 1" damncrud && break
          sleep 2
        done

    - name: Setup MySQL Database
      run: |
        # Check if damncrud database exists
        mysql -h 127.0.0.1 -u root --protocol=TCP -e "SHOW DATABASES LIKE 'damncrud';" | grep damncrud || mysql -h 127.0.0.1 -u root --protocol=TCP -e "CREATE DATABASE damncrud;"
        # Import schema
        mysql -h 127.0.0.1 -u root --protocol=TCP damncrud < db/damncrud.sql

    - name: Verify Database
      run: |
        mysql -h 127.0.0.1 -u root --protocol=TCP damncrud -e "SHOW TABLES;" && echo "Database verified successfully"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup Chrome for WebDriver (Headless)
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver

    - name: Verify Application is Running
      run: |
        curl -s http://localhost/DamnCRUD/login.php | grep -q "Damn, sign in" && echo "Application is running" || exit 1

    - name: Update PHP Database Configuration
      run: |
        # Update functions.php for GitHub Actions environment
        sudo sed -i "s/localhost/127.0.0.1/g" /var/www/html/DamnCRUD/functions.php
        sudo cat /var/www/html/DamnCRUD/functions.php | grep -A 5 "DATABASE"

    - name: Verify Application is Running
      run: |
        curl -s http://localhost/DamnCRUD/login.php | grep -q "Damn" && echo "Application is accessible" || (echo "Application failed to load" && exit 1)

    - name: Create test reports directory
      run: mkdir -p /var/www/html/DamnCRUD/tests/reports

    - name: Run Pytest with Parallel Execution (xdist)
      run: |
        cd /var/www/html/DamnCRUD
        python -m pytest tests/ -v --tb=short -n auto --html=tests/reports/report.html --self-contained-html --junitxml=tests/reports/junit.xml 2>&1 | tee pytest_output.log
      continue-on-error: true
      timeout-minutes: 15

    - name: Copy test reports to workspace
      if: always()
      run: |
        mkdir -p tests/reports
        cp -r /var/www/html/DamnCRUD/tests/reports/* tests/reports/ 2>/dev/null || true
        ls -la tests/reports/ || echo "No reports directory"

    - name: Display Test Results
      if: always()
      run: |
        if [ -f tests/reports/junit.xml ]; then
          cat tests/reports/junit.xml
        elif [ -f /var/www/html/DamnCRUD/tests/reports/junit.xml ]; then
          cat /var/www/html/DamnCRUD/tests/reports/junit.xml
        fi

    - name: Upload Test Report (HTML)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-html-report
        path: tests/reports/report.html
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload Test Report (JUnit XML)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-junit-report
        path: tests/reports/junit.xml
        retention-days: 30
        if-no-files-found: ignore

    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: |
          tests/reports/junit.xml
        check_name: Pytest Results
      continue-on-error: true

    - name: Test Summary
      if: always()
      run: |
        echo "=== DamnCRUD Functional Testing Summary ==="
        echo "Pipeline: Completed"
        echo "Test Framework: Pytest with xdist"
        echo "Parallel Execution: Enabled (auto-detected CPU cores)"
        echo ""
        if [ -f tests/reports/junit.xml ]; then
          echo "Report Status: Generated successfully"
          echo "Reports location: tests/reports/"
        elif [ -f /var/www/html/DamnCRUD/tests/reports/junit.xml ]; then
          echo "Report Status: Generated at /var/www/html/DamnCRUD/tests/reports/"
        else
          echo "Report Status: Not found (tests may have failed)"
        fi

  # Job untuk code quality
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Lint Python code
      run: |
        python -m pip install flake8 pylint
        echo "Running Flake8..."
        flake8 tests/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "Flake8 check completed"

  # Job status check
  all-tests:
    if: always()
    needs: [test, code-quality]
    runs-on: ubuntu-latest
    steps:
    - name: Check if any job failed
      run: |
        if [ "${{ needs.test.result }}" = "failure" ]; then
          echo "Functional tests failed!"
          exit 1
        fi
        echo "All checks passed!"
